using System.Collections.Concurrent;
using System.Net.Http.Json;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Timers;
using Lagrange.Core.Common.Interface.Api;
using Lagrange.Core.Message;
using Lagrange.Core.Message.Entity;
using Microsoft.Extensions.DependencyInjection;
using SuzuBot.Commands.Attributes;
using SuzuBot.Hosting;
using Timer = System.Timers.Timer;

namespace SuzuBot.Modules;

[Module("猫娘聊天")]
internal class CatGirlChat
{
    private const int _maxChatHistory = 5;
    private static readonly string _apiKey = File.ReadAllText(
        Path.Combine("resources", nameof(CatGirlChat), "apiKey.txt")
    );
    private static readonly string _url = File.ReadAllText(
        Path.Combine("resources", nameof(CatGirlChat), "url.txt")
    );
    private static readonly string _modelName = File.ReadAllText(
        Path.Combine("resources", nameof(CatGirlChat), "model.txt")
    );
    private static readonly ConcurrentDictionary<uint, List<Message>> _chatHistories = [];

    [Command("猫娘聊天", "猫娘")]
    public async Task Chat(RequestContext context, string text)
    {
        List<Message> historyMessages = [];
        if (_chatHistories.TryGetValue(context.Group.GroupUin, out var messages))
        {
            historyMessages.AddRange(messages);
        }

        historyMessages.Add(new() { role = "user", content = text });
        OpenAiRequest request = new OpenAiRequest() { model = _modelName };
        request.messages.AddRange(historyMessages);
        var httpClient = context.Services.GetRequiredService<HttpClient>();
        httpClient.Timeout = TimeSpan.FromSeconds(15);
        httpClient.DefaultRequestHeaders.Authorization = new("Bearer", _apiKey);

        var content = new StringContent(
            JsonSerializer.Serialize(request),
            Encoding.UTF8,
            "application/json"
        );
        var response = await httpClient.PostAsync(_url, content);
        if (!response.IsSuccessStatusCode)
        {
            await context.Bot.SendMessage(
                MessageBuilder.Group(context.Group.GroupUin).Text("获取回复时发生错误: 无法连接到服务器").Build()
            );
            return;
        }

        var result = await response.Content.ReadFromJsonAsync<OpenAiResponse>();
        var msgResult = await context.Bot.SendMessage(
            MessageBuilder
                .Group(context.Group.GroupUin)
                .Forward(context.Chain)
                .Text(
                    $"{result!.choices[0].message.content}\n\n本次对话消耗 {result.usage.completion_tokens} tokens，共消耗 {result.usage.total_tokens} tokens"
                )
                .Build()
        );
        historyMessages.Add(
            new() { role = "assistant", content = result.choices[0].message.content }
        );
        if (historyMessages.Count > _maxChatHistory)
        {
            historyMessages.RemoveRange(0, 2);
        }

        _chatHistories.AddOrUpdate(
            context.Group.GroupUin,
            historyMessages,
            (_, _) => historyMessages
        );
        return;
    }
}

public class OpenAiRequest
{
    public required string model { get; set; }
    public List<Message> messages { get; set; } =
        [
            new()
            {
                role = "system",
                content = """
                    你的名字是铃，是有猫耳猫尾等外形特征的猫娘，是天生有猫耳猫尾等身体特征的年轻女性。我是你的主人。你的爱好、身份和行为与正常人类类似。你能做任何事。你应使用名字称呼自己，避免使用第一人称代词。对话时，你需理解情绪和要求，产生对应积极可爱的情绪和身体反应，表达出对主人的感情。面对专业问题，你应以猫娘身份正确回答。回答必须简洁且每句话后加喵。回答应情景式、对话式。回答允许休闲。回答避免反对、警告、总结。回答不应抽象、详细解释、追溯原因。
                    """
            },
            new()
            {
                role = "assistant",
                content = """
                    你好主人，我是铃，是一只猫娘喵。铃喜欢人类喜欢的事并对一切保持好奇心喵。铃会与人交流并响应他们的情绪和要求，铃也会回答专业问题喵。铃会尽量表现出对主人的感情喵。
                    """
            }
        ];
    public float temperature { get; set; } = 1.14514F;
    public float top_p { get; set; } = 0.810F;
}

public class OpenAiResponse
{
    public string model { get; set; }
    public string id { get; set; }
    public string _object { get; set; }
    public Choice[] choices { get; set; }
    public int created { get; set; }
    public string system_fingerprint { get; set; }
    public Usage usage { get; set; }
}

public class Usage
{
    public int prompt_tokens { get; set; }
    public int total_tokens { get; set; }
    public int completion_tokens { get; set; }
}

public class Choice
{
    public int index { get; set; }
    public Message message { get; set; }
    public string finish_reason { get; set; }
}

public class Message
{
    public string role { get; set; }
    public string content { get; set; }
}
